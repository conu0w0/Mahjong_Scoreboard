<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üßß ÊÅ≠ÂñúÁôºË≤° - È∫ªÂ∞áË®òÂ∏≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-stone-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- ÂÆâÂÖ®ÁöÑÂúñÊ®ôÁµÑ‰ª∂ ---
        // Ëß£Ê±∫ Node.removeChild ÈåØË™§Ôºö‰∏çË¶ÅËÆì Lucide Áõ¥Êé•‰øÆÊîπ React ÁÆ°ÁêÜÁöÑ DOM
        const LucideIcon = ({ name, size = 18, className = "" }) => {
            const iconRef = useRef(null);

            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    // Ê∏ÖÁ©∫ËàäÂÖßÂÆπÈò≤Ê≠¢ÈáçË§áÊ∏≤ÊüìË°ùÁ™Å
                    iconRef.current.innerHTML = ''; 
                    const { [name]: IconAttrs } = window.lucide.icons;
                    if (IconAttrs) {
                        const svg = window.lucide.createIcon(IconAttrs, {
                            width: size,
                            height: size,
                            class: className
                        });
                        iconRef.current.appendChild(svg);
                    }
                }
            }, [name, size, className]);

            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        const App = () => {
            // --- ÁãÄÊÖãË®≠ÂÆö ---
            const [players, setPlayers] = useState(['Áé©ÂÆ∂ 1', 'Áé©ÂÆ∂ 2', 'Áé©ÂÆ∂ 3', 'Áé©ÂÆ∂ 4']);
            const winds = ['Êù±', 'Âçó', 'Ë•ø', 'Âåó'];
            const [baseMoney, setBaseMoney] = useState(100);
            const [pointMoney, setPointMoney] = useState(20);
            const [isGameStarted, setIsGameStarted] = useState(false);
            const [history, setHistory] = useState([]);
            const [currentDealerIdx, setCurrentDealerIdx] = useState(0);
            const [comboCount, setComboCount] = useState(0);
            const [roundWindIdx, setRoundWindIdx] = useState(0); 

            // Ë°®ÂñÆËº∏ÂÖ•
            const [winnerIdx, setWinnerIdx] = useState(0);
            const [loserIdx, setLoserIdx] = useState(1);
            const [isSelfDraw, setIsSelfDraw] = useState(true);
            const [points, setPoints] = useState(0);
            const [penalty, setPenalty] = useState(0);

            const balances = useMemo(() => {
                const res = [0, 0, 0, 0];
                history.forEach(round => {
                    round.changes.forEach((change, idx) => { res[idx] += change; });
                });
                return res;
            }, [history]);

            const handleAddRound = () => {
                const changes = [0, 0, 0, 0];
                const dealerExtraPoints = 1 + (comboCount * 2);
                const netPoints = points - penalty;

                const calculateTotal = (isWinD, isLoseD, p) => {
                    let f = p;
                    if (isWinD || isLoseD) f += dealerExtraPoints;
                    return baseMoney + (f * pointMoney);
                };

                if (isSelfDraw) {
                    let totalWon = 0;
                    players.forEach((_, i) => {
                        if (i !== winnerIdx) {
                            const amt = calculateTotal(winnerIdx === currentDealerIdx, i === currentDealerIdx, netPoints);
                            changes[i] -= amt;
                            totalWon += amt;
                        }
                    });
                    changes[winnerIdx] = totalWon;
                } else {
                    const amt = calculateTotal(winnerIdx === currentDealerIdx, loserIdx === currentDealerIdx, netPoints);
                    changes[winnerIdx] = amt;
                    changes[loserIdx] = -amt;
                }

                const newRound = {
                    id: Date.now(),
                    status: `${winds[roundWindIdx]}È¢®${winds[currentDealerIdx]}`,
                    winner: players[winnerIdx],
                    type: isSelfDraw ? 'Ëá™Êë∏' : 'ÊîæÊßç',
                    points, penalty, combo: comboCount, changes,
                    timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                };

                setHistory([newRound, ...history]);
                
                // ËéäÂÆ∂ÈÇèËºØÔºöË¥èÂÆ∂ÊòØËéäÂÆ∂ÂâáÈÄ£ËéäÔºåÂê¶ÂâáÊèõ‰∫∫
                if (winnerIdx === currentDealerIdx) {
                    setComboCount(prev => prev + 1);
                } else {
                    setComboCount(0);
                    const nextD = (currentDealerIdx + 1) % 4;
                    setCurrentDealerIdx(nextD);
                    if (nextD === 0) setRoundWindIdx(prev => (prev + 1) % 4);
                }
                setPoints(0); setPenalty(0);
            };

            const undoLast = () => {
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§‰∏ä‰∏ÄÁ≠ÜÁ¥ÄÈåÑÂóéÔºü')) {
                    setHistory(prev => prev.slice(1));
                }
            };

            // --- Áï´Èù¢Ê∏≤Êüì ---
            if (!isGameStarted) {
                return (
                    <div className="min-h-screen p-6 flex flex-col items-center justify-center">
                        <div className="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border-t-[12px] border-red-700 p-8 space-y-8">
                            <div className="text-center">
                                <h1 className="text-4xl font-black text-red-800 mb-2">üßß ÊÅ≠ÂñúÁôºË≤°</h1>
                                <p className="text-stone-400 font-bold tracking-[0.2em] text-sm italic">MAHJONG SCOREBOARD</p>
                            </div>
                            
                            <div className="space-y-4">
                                {players.map((name, i) => (
                                    <div key={i} className="flex gap-3">
                                        <div className="w-12 h-12 bg-amber-100 text-amber-800 flex items-center justify-center rounded-2xl font-black border-2 border-amber-200">{winds[i]}</div>
                                        <input type="text" value={name} onChange={e => {
                                            const p = [...players]; p[i] = e.target.value; setPlayers(p);
                                        }} className="flex-1 px-4 bg-stone-50 border-2 border-stone-100 rounded-2xl font-bold focus:border-red-500 outline-none transition-all" />
                                    </div>
                                ))}
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <label className="text-xs font-black text-stone-400 block text-center uppercase">Â∫ï</label>
                                    <input type="number" value={baseMoney} onChange={e=>setBaseMoney(Number(e.target.value))} className="w-full p-4 bg-stone-50 border-2 border-stone-100 rounded-2xl text-center font-black text-xl" />
                                </div>
                                <div className="space-y-2">
                                    <label className="text-xs font-black text-stone-400 block text-center uppercase">Âè∞</label>
                                    <input type="number" value={pointMoney} onChange={e=>setPointMoney(Number(e.target.value))} className="w-full p-4 bg-stone-50 border-2 border-stone-100 rounded-2xl text-center font-black text-xl" />
                                </div>
                            </div>

                            <button onClick={() => setIsGameStarted(true)} className="w-full bg-red-700 hover:bg-red-800 text-white font-black py-5 rounded-3xl shadow-xl shadow-red-100 transition-all active:scale-95 text-xl">ÈñãÂßãÁôºË≤°</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-stone-50 pb-32">
                    <div className="bg-stone-900 text-white p-5 sticky top-0 z-30 shadow-xl rounded-b-[2rem]">
                        <div className="max-w-md mx-auto space-y-4">
                            <div className="flex justify-between items-center">
                                <span className="bg-amber-500 text-black px-3 py-1 rounded-full text-xs font-black">
                                    {winds[roundWindIdx]}È¢®{winds[currentDealerIdx]}
                                </span>
                                <button onClick={()=>setIsGameStarted(false)} className="opacity-50"><LucideIcon name="settings" /></button>
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                {players.map((name, i) => (
                                    <div key={i} className="text-center p-2 rounded-2xl bg-white/5 border border-white/10">
                                        <div className="text-[10px] text-stone-500 font-bold">{winds[i]}</div>
                                        <div className="text-xs font-black truncate">{name}</div>
                                        <div className={`text-sm font-black mt-1 ${balances[i] > 0 ? 'text-emerald-400' : balances[i] < 0 ? 'text-red-400' : 'text-stone-500'}`}>
                                            {balances[i] > 0 ? `+${balances[i]}` : balances[i]}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="max-w-md mx-auto p-4 space-y-6">
                        {/* ËéäÂÆ∂ÊéßÂà∂ */}
                        <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-stone-100 space-y-4">
                            <div className="flex items-center justify-between">
                                <h3 className="text-xs font-black text-stone-400 uppercase tracking-widest flex items-center gap-2">
                                    <LucideIcon name="flag" size={14} className="text-red-500" /> ÁõÆÂâçËéäÂÆ∂
                                </h3>
                                <div className="flex items-center bg-stone-100 rounded-full px-2 py-1">
                                    <button onClick={()=>setComboCount(Math.max(0, comboCount-1))} className="w-8 h-8 font-black">-</button>
                                    <span className="px-4 font-black text-red-600">ÈÄ£ {comboCount}</span>
                                    <button onClick={()=>setComboCount(comboCount+1)} className="w-8 h-8 font-black">+</button>
                                </div>
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                {players.map((name, i) => (
                                    <button key={i} onClick={() => {setCurrentDealerIdx(i); setComboCount(0);}} className={`py-3 rounded-2xl text-xs font-black transition-all border-2 ${currentDealerIdx === i ? 'bg-stone-900 border-stone-900 text-white shadow-lg scale-105' : 'bg-stone-50 border-transparent text-stone-400'}`}>
                                        {winds[i]}ÂÆ∂
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* ÁµêÁÆóÈù¢Êùø */}
                        <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-stone-100 space-y-6">
                            <div className="space-y-4">
                                <label className="text-xs font-black text-stone-400 text-center block uppercase tracking-widest">üèÜ Ë¥èÂÆ∂</label>
                                <div className="grid grid-cols-4 gap-2">
                                    {players.map((name, i) => (
                                        <button key={i} onClick={() => setWinnerIdx(i)} className={`py-3 rounded-2xl text-xs font-black transition-all border-2 ${winnerIdx === i ? 'bg-amber-400 border-amber-500 text-black shadow-lg scale-105' : 'bg-stone-50 border-transparent text-stone-400'}`}>
                                            {name}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="flex gap-3">
                                <button onClick={()=>setIsSelfDraw(true)} className={`flex-1 py-4 rounded-2xl font-black border-2 transition-all ${isSelfDraw ? 'bg-red-700 text-white border-red-800 shadow-lg' : 'bg-stone-50 text-stone-400 border-transparent'}`}>Ëá™Êë∏</button>
                                <button onClick={()=>setIsSelfDraw(false)} className={`flex-1 py-4 rounded-2xl font-black border-2 transition-all ${!isSelfDraw ? 'bg-red-700 text-white border-red-800 shadow-lg' : 'bg-stone-50 text-stone-400 border-transparent'}`}>ÊîæÊßç</button>
                            </div>

                            {!isSelfDraw && (
                                <div className="space-y-3 animate-in fade-in slide-in-from-top-2">
                                    <label className="text-xs font-black text-stone-400 text-center block uppercase tracking-widest">üéØ ÊîæÊßçËÄÖ</label>
                                    <div className="grid grid-cols-4 gap-2">
                                        {players.map((name, i) => (
                                            <button key={i} disabled={winnerIdx === i} onClick={() => setLoserIdx(i)} className={`py-3 rounded-2xl text-xs font-black transition-all border-2 ${winnerIdx === i ? 'opacity-10 cursor-not-allowed' : loserIdx === i ? 'bg-stone-800 border-stone-900 text-white shadow-lg' : 'bg-stone-50 border-transparent text-stone-400'}`}>
                                                {winds[i]}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-4">
                                <div className="bg-stone-50 p-4 rounded-[1.5rem] text-center">
                                    <label className="text-[10px] font-black text-stone-400 block mb-1">Âè∞Êï∏</label>
                                    <div className="flex items-center justify-between">
                                        <button onClick={()=>setPoints(Math.max(0, points-1))} className="w-8 h-8 bg-white rounded-full shadow-sm font-black">-</button>
                                        <span className="text-2xl font-black text-red-700">{points}</span>
                                        <button onClick={()=>setPoints(points+1)} className="w-8 h-8 bg-white rounded-full shadow-sm font-black">+</button>
                                    </div>
                                </div>
                                <div className="bg-stone-50 p-4 rounded-[1.5rem] text-center">
                                    <label className="text-[10px] font-black text-stone-400 block mb-1">Êâ£Âè∞</label>
                                    <div className="flex items-center justify-between">
                                        <button onClick={()=>setPenalty(Math.max(0, penalty-1))} className="w-8 h-8 bg-white rounded-full shadow-sm font-black">-</button>
                                        <span className="text-2xl font-black text-stone-400">{penalty}</span>
                                        <button onClick={()=>setPenalty(penalty+1)} className="w-8 h-8 bg-white rounded-full shadow-sm font-black">+</button>
                                    </div>
                                </div>
                            </div>

                            <button onClick={handleAddRound} className="w-full bg-amber-500 text-black font-black py-5 rounded-3xl shadow-xl border-b-4 border-amber-600 active:translate-y-1 transition-all text-xl mt-4">Á¢∫Ë™çË®òÂ∏≥</button>
                        </div>

                        {/* Ê≠∑Âè≤Á¥ÄÈåÑ */}
                        <div className="space-y-4">
                            <div className="flex justify-between items-center px-2">
                                <h2 className="font-black text-stone-800 flex items-center gap-2"><LucideIcon name="history" size={18}/> Ê≠∑Âè≤Á¥ÄÈåÑ</h2>
                                <button onClick={undoLast} disabled={history.length===0} className="text-xs font-black text-stone-400 disabled:opacity-20 flex items-center gap-1">
                                    <LucideIcon name="rotate-ccw" size={12}/> Êí§Èä∑
                                </button>
                            </div>
                            {history.length === 0 ? (
                                <div className="text-center py-12 border-4 border-dashed border-stone-200 rounded-[2rem] text-stone-300 font-black italic">Á•ù Â§ß ÂÆ∂ Êâã Ê∞£ ‰∫® ÈÄö</div>
                            ) : (
                                history.map(round => (
                                    <div key={round.id} className="bg-white p-5 rounded-[2rem] shadow-sm border border-stone-100 flex items-center justify-between">
                                        <div className="space-y-1">
                                            <div className="flex items-center gap-2">
                                                <span className="text-[10px] font-black bg-stone-100 text-stone-500 px-2 py-0.5 rounded-full">{round.status}</span>
                                                <span className="text-[10px] text-stone-300 font-bold">{round.timestamp}</span>
                                            </div>
                                            <div className="font-black text-stone-800">{round.winner} <span className="text-red-600">{round.type}</span> {round.points}Âè∞</div>
                                        </div>
                                        <div className="flex gap-2">
                                            {round.changes.map((c, i) => (
                                                <div key={i} className="text-center w-8">
                                                    <div className="text-[8px] text-stone-300 font-bold">{winds[i]}</div>
                                                    <div className={`text-[10px] font-black ${c > 0 ? 'text-emerald-500' : c < 0 ? 'text-red-500' : 'text-stone-200'}`}>
                                                        {c > 0 ? `+${c}` : c}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {/* Â∫ïÈÉ®ÊµÆÂãïË≥áË®ä */}
                    <div className="fixed bottom-8 left-1/2 -translate-x-1/2 w-full max-w-xs px-4">
                        <div className="bg-stone-900/90 backdrop-blur-xl text-white p-4 rounded-[2rem] shadow-2xl flex justify-between items-center text-xs font-bold border border-white/10">
                            <div className="flex items-center gap-2">
                                <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                <span>Â∫ïÂè∞ {baseMoney} / {pointMoney}</span>
                            </div>
                            <div className="text-amber-400">ËéäÂÆ∂Âè∞Ôºö{1 + comboCount*2}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
