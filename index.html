<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£éº»å°‡è¨˜å¸³ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* ç§»é™¤ Chrome/Safari çš„æ•¸å­—è¼¸å…¥ç®­é ­ */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 min-h-screen">
    <div id="app"></div>

    <script>
        // --- æ ¸å¿ƒç‹€æ…‹ç®¡ç† (å°æ‡‰ React useState) ---
        let state = {
            players: ['ç©å®¶ 1', 'ç©å®¶ 2', 'ç©å®¶ 3', 'ç©å®¶ 4'],
            winds: ['æ±', 'å—', 'è¥¿', 'åŒ—'],
            baseMoney: 100,
            pointMoney: 20,
            isGameStarted: false,
            history: [],
            currentDealerIdx: 0,
            comboCount: 0,
            roundWindIdx: 0,
            winnerIdx: 0,
            loserIdx: 1,
            isSelfDraw: true,
            points: 0,
            penalty: 0
        };

        // --- è¨ˆç®—é‚è¼¯ (å°æ‡‰ React useMemo / è¼”åŠ©å‡½æ•¸) ---
        function getBalances() {
            const res = [0, 0, 0, 0];
            state.history.forEach(round => {
                round.changes.forEach((change, idx) => {
                    res[idx] += change;
                });
            });
            return res;
        }

        const getRoundStatus = (rIdx, dIdx) => {
            return `${state.winds[rIdx]}é¢¨${state.winds[dIdx]}`;
        };

        // --- å‹•ä½œè™•ç† (å°æ‡‰ handleAddRound) ---
        function handleAddRound() {
            const changes = [0, 0, 0, 0];
            const dealerExtraPoints = 1 + (state.comboCount * 2);
            const netPoints = state.points - state.penalty;

            const calculateTotal = (isWinnerDealer, isLoserDealer, rawPoints) => {
                let finalPoints = rawPoints;
                if (isWinnerDealer || isLoserDealer) {
                    finalPoints += dealerExtraPoints;
                }
                return state.baseMoney + (finalPoints * state.pointMoney);
            };

            if (state.isSelfDraw) {
                let totalWon = 0;
                state.players.forEach((_, idx) => {
                    if (idx !== state.winnerIdx) {
                        const amount = calculateTotal(state.winnerIdx === state.currentDealerIdx, idx === state.currentDealerIdx, netPoints);
                        changes[idx] -= amount;
                        totalWon += amount;
                    }
                });
                changes[state.winnerIdx] = totalWon;
            } else {
                const amount = calculateTotal(state.winnerIdx === state.currentDealerIdx, state.loserIdx === state.currentDealerIdx, netPoints);
                changes[state.winnerIdx] = amount;
                changes[state.loserIdx] = -amount;
            }

            const currentStatus = getRoundStatus(state.roundWindIdx, state.currentDealerIdx);

            const newRound = {
                id: Date.now(),
                status: currentStatus,
                winner: state.players[state.winnerIdx],
                winnerWind: state.winds[state.winnerIdx],
                type: state.isSelfDraw ? 'è‡ªæ‘¸' : 'æ”¾æ§',
                loser: state.isSelfDraw ? 'ä¸‰å®¶' : state.players[state.loserIdx],
                loserWind: state.isSelfDraw ? '' : state.winds[state.loserIdx],
                points: state.points,
                penalty: state.penalty,
                dealer: state.players[state.currentDealerIdx],
                dealerWind: state.winds[state.currentDealerIdx],
                combo: state.comboCount,
                changes: changes,
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            };

            state.history = [newRound, ...state.history];
            
            if (state.winnerIdx === state.currentDealerIdx) {
                state.comboCount += 1;
            } else {
                state.comboCount = 0;
                const nextDealerIdx = (state.currentDealerIdx + 1) % 4;
                state.currentDealerIdx = nextDealerIdx;
                if (nextDealerIdx === 0) {
                    state.roundWindIdx = (state.roundWindIdx + 1) % 4;
                }
            }
            state.points = 0;
            state.penalty = 0;
            render();
        }

        function undoLastRound() {
            if (state.history.length === 0) return;
            state.history.shift();
            render();
        }

        // --- UI æ¸²æŸ“é‚è¼¯ (å°æ‡‰ React Component) ---
        function render() {
            const app = document.getElementById('app');
            
            if (!state.isGameStarted) {
                app.innerHTML = renderSetupView();
            } else {
                app.innerHTML = renderGameView();
            }
            // é‡æ–°åˆå§‹åŒ– Lucide åœ–ç¤º
            lucide.createIcons();
        }

        function renderSetupView() {
            return `
                <div class="min-h-screen bg-stone-100 p-4 font-sans text-stone-800 flex items-center justify-center text-[16px]">
                    <div class="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden border-t-8 border-red-700">
                        <div class="p-8 text-center bg-stone-50 border-b border-stone-100">
                            <h1 class="text-3xl font-black text-red-800 mb-2">ğŸ§§ æ­å–œç™¼è²¡</h1>
                            <p class="text-stone-500 font-medium tracking-widest text-sm uppercase">å° ç£ éº» å°‡ è¨˜ å¸³ ç³» çµ±</p>
                        </div>
                        <div class="p-6 space-y-6">
                            <div class="space-y-3">
                                <label class="flex items-center gap-2 text-sm font-bold text-stone-600">
                                    <i data-lucide="users" class="w-[18px] h-[18px]"></i> ç©å®¶è¨­å®š (åˆå§‹é¢¨ä½)
                                </label>
                                <div class="space-y-2">
                                    ${state.players.map((name, i) => `
                                        <div class="flex items-center gap-2">
                                            <div class="w-12 h-12 bg-amber-50 text-amber-700 flex items-center justify-center rounded-xl font-black text-lg shrink-0 border border-amber-200">
                                                ${state.winds[i]}
                                            </div>
                                            <input type="text" value="${name}" onchange="state.players[${i}]=this.value" class="flex-1 p-3 border-2 border-stone-100 rounded-xl focus:border-red-500 outline-none transition-all font-bold">
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="text-sm font-bold text-stone-600 block text-center">åº•</label>
                                    <input type="number" value="${state.baseMoney}" onchange="state.baseMoney=Number(this.value)" class="w-full p-4 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-red-500 outline-none text-center text-xl font-black">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-sm font-bold text-stone-600 block text-center">å°</label>
                                    <input type="number" value="${state.pointMoney}" onchange="state.pointMoney=Number(this.value)" class="w-full p-4 bg-stone-50 border-2 border-stone-100 rounded-xl focus:border-red-500 outline-none text-center text-xl font-black">
                                </div>
                            </div>
                            <button onclick="state.isGameStarted=true; render()" class="w-full bg-red-700 hover:bg-red-800 text-white font-black py-4 rounded-2xl shadow-lg shadow-red-100 transition-all text-lg flex items-center justify-center gap-2 active:scale-95">
                                å°å±€é–‹å§‹
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGameView() {
            const balances = getBalances();
            return `
                <!-- Header -->
                <div class="bg-stone-800 text-stone-100 p-4 sticky top-0 z-20 shadow-lg border-b border-stone-700">
                    <div class="max-w-md mx-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h1 class="text-xl font-black flex items-center gap-2">
                                <span class="bg-amber-500 text-stone-900 px-2 py-0.5 rounded text-sm shadow-sm">
                                    ${getRoundStatus(state.roundWindIdx, state.currentDealerIdx)}
                                </span> 
                                è¨ˆåˆ†æ¿
                            </h1>
                            <button onclick="state.isGameStarted=false; render()" class="bg-white/10 p-2 rounded-full hover:bg-white/20 transition-colors border border-white/5">
                                <i data-lucide="settings" class="w-[18px] h-[18px] text-stone-300"></i>
                            </button>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            ${state.players.map((name, i) => `
                                <div class="bg-stone-900/40 backdrop-blur-sm rounded-2xl p-2 text-center border border-white/5 shadow-inner">
                                    <div class="text-[10px] text-stone-400 mb-0.5 font-bold uppercase tracking-tighter">${state.winds[i]}ä½</div>
                                    <div class="text-[12px] font-bold truncate mb-1 text-stone-200">${name}</div>
                                    <div class="text-sm font-black truncate ${balances[i] > 0 ? 'text-emerald-400' : balances[i] < 0 ? 'text-rose-500' : 'text-stone-500'}">
                                        ${balances[i] > 0 ? '+' + balances[i] : balances[i]}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <div class="max-w-md mx-auto p-4 space-y-4 pb-24">
                    <!-- Input Area -->
                    <div class="bg-white rounded-3xl shadow-sm border border-stone-200 p-5 space-y-6">
                        <!-- ç›®å‰èŠå®¶ -->
                        <div class="flex items-center justify-between gap-4">
                            <div class="flex-1">
                                <label class="text-xs font-bold text-stone-400 block mb-3 uppercase tracking-wider text-center">ğŸš© ç›®å‰èŠå®¶</label>
                                <div class="grid grid-cols-4 gap-2">
                                    ${state.players.map((name, i) => `
                                        <button onclick="state.currentDealerIdx=${i}; state.comboCount=0; render()" class="py-3 rounded-xl font-black transition-all border-2 flex flex-col items-center justify-center ${state.currentDealerIdx === i ? 'bg-stone-800 border-stone-900 text-stone-100 shadow-md ring-2 ring-stone-800 ring-offset-2' : 'bg-white border-stone-100 text-stone-400'}">
                                            <span class="truncate w-full px-1 text-xs">${name}</span>
                                            <span class="text-[10px] font-bold ${state.currentDealerIdx === i ? 'text-amber-400' : 'text-stone-300'}">(${state.winds[i]})</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="w-20 shrink-0">
                                <label class="text-xs font-bold text-stone-400 block mb-3 uppercase tracking-wider text-center">é€£èŠ</label>
                                <div class="flex items-center">
                                    <button onclick="state.comboCount=Math.max(0, state.comboCount-1); render()" class="w-7 h-11 bg-stone-100 rounded-l-xl flex items-center justify-center font-bold active:bg-stone-200">-</button>
                                    <div class="flex-1 h-11 bg-stone-50 flex items-center justify-center font-black text-red-700 border-y-2 border-stone-100">${state.comboCount}</div>
                                    <button onclick="state.comboCount++; render()" class="w-7 h-11 bg-stone-100 rounded-r-xl flex items-center justify-center font-bold active:bg-stone-200">+</button>
                                </div>
                            </div>
                        </div>

                        <hr class="border-stone-100" />

                        <!-- è´å®¶çµç®— -->
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-stone-400 block mb-3 uppercase tracking-wider text-center">ğŸ† è´å®¶çµç®—</label>
                                <div class="grid grid-cols-4 gap-2">
                                    ${state.players.map((name, i) => `
                                        <button onclick="state.winnerIdx=${i}; render()" class="py-3 rounded-xl font-black transition-all border-2 flex flex-col items-center justify-center ${state.winnerIdx === i ? 'bg-amber-500 border-amber-600 text-white shadow-md scale-105 z-10 ring-2 ring-amber-500 ring-offset-2' : 'bg-white border-stone-100 text-stone-400'}">
                                            <span class="truncate w-full px-1 text-xs">${name}</span>
                                            <span class="text-[10px] font-bold ${state.winnerIdx === i ? 'text-amber-100' : 'text-stone-300'}">(${state.winds[i]})</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="state.isSelfDraw=true; render()" class="py-4 rounded-xl font-black text-lg flex items-center justify-center gap-2 border-2 ${state.isSelfDraw ? 'bg-red-700 border-red-800 text-white shadow-md' : 'bg-white border-stone-100 text-stone-400'}">è‡ªæ‘¸</button>
                                <button onclick="state.isSelfDraw=false; render()" class="py-4 rounded-xl font-black text-lg flex items-center justify-center gap-2 border-2 ${!state.isSelfDraw ? 'bg-red-700 border-red-800 text-white shadow-md' : 'bg-white border-stone-100 text-stone-400'}">æ”¾æ§</button>
                            </div>
                            ${!state.isSelfDraw ? `
                                <div class="animate-slide-in">
                                    <label class="text-xs font-bold text-stone-400 block mb-3 uppercase tracking-wider text-center">ğŸ¯ èª°æ”¾æ§ï¼Ÿ</label>
                                    <div class="grid grid-cols-4 gap-2">
                                        ${state.players.map((name, i) => `
                                            <button onclick="state.loserIdx=${i}; render()" ${state.winnerIdx === i ? 'disabled' : ''} class="py-3 rounded-xl font-black transition-all border-2 flex flex-col items-center justify-center ${state.winnerIdx === i ? 'opacity-20 cursor-not-allowed border-dashed' : state.loserIdx === i ? 'bg-stone-700 border-stone-800 text-white shadow-md scale-105 ring-2 ring-stone-700 ring-offset-2' : 'bg-white border-stone-100 text-stone-400'}">
                                                <span class="truncate w-full px-1 text-xs">${name}</span>
                                                <span class="text-[10px] font-bold text-stone-300">(${state.winds[i]})</span>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- å°æ•¸è¼¸å…¥ -->
                        <div class="space-y-4">
                            <div class="bg-stone-50 p-4 rounded-2xl border border-stone-100">
                                <label class="text-xs font-bold text-stone-400 block mb-4 uppercase tracking-wider text-center">è´ç‰Œå°æ•¸ <span class="text-[10px] opacity-60">(ä¸å«èŠå®¶å°)</span></label>
                                <div class="flex items-center justify-center gap-8">
                                    <button onclick="state.points=Math.max(0, state.points-1); render()" class="w-12 h-12 bg-white border-2 border-stone-300 shadow-sm rounded-full flex items-center justify-center text-stone-700 active:scale-90 transition-all"><i data-lucide="chevron-down" class="w-7 h-7 stroke-[2.5]"></i></button>
                                    <div class="relative">
                                        <input type="number" value="${state.points}" onchange="state.points=Math.max(0, Number(this.value)); render()" class="w-16 text-center text-4xl font-black text-red-700 outline-none bg-transparent">
                                        <div class="absolute -right-5 bottom-1 text-xs font-bold text-stone-300">å°</div>
                                    </div>
                                    <button onclick="state.points++; render()" class="w-12 h-12 bg-white border-2 border-stone-300 shadow-sm rounded-full flex items-center justify-center text-stone-700 active:scale-90 transition-all"><i data-lucide="chevron-up" class="w-7 h-7 stroke-[2.5]"></i></button>
                                </div>
                            </div>
                            <div class="bg-rose-50/30 p-4 rounded-2xl border border-rose-100">
                                <label class="text-xs font-bold text-rose-400 block mb-4 uppercase tracking-wider text-center">çŠ¯è¦æ‰£å° <span class="text-[10px] opacity-60">(å¾è´å®¶ç¸½å°æ•¸æ‰£é™¤)</span></label>
                                <div class="flex items-center justify-center gap-8">
                                    <button onclick="state.penalty=Math.max(0, state.penalty-1); render()" class="w-12 h-12 bg-white border-2 border-rose-200 shadow-sm rounded-full flex items-center justify-center text-rose-400 active:scale-90 transition-all"><i data-lucide="chevron-down" class="w-7 h-7 stroke-[2.5]"></i></button>
                                    <div class="relative">
                                        <input type="number" value="${state.penalty}" onchange="state.penalty=Math.max(0, Number(this.value)); render()" class="w-16 text-center text-4xl font-black text-rose-500 outline-none bg-transparent">
                                        <div class="absolute -right-5 bottom-1 text-xs font-bold text-rose-200">å°</div>
                                    </div>
                                    <button onclick="state.penalty++; render()" class="w-12 h-12 bg-white border-2 border-rose-200 shadow-sm rounded-full flex items-center justify-center text-rose-400 active:scale-90 transition-all"><i data-lucide="chevron-up" class="w-7 h-7 stroke-[2.5]"></i></button>
                                </div>
                            </div>
                        </div>

                        <button onclick="handleAddRound()" class="w-full bg-amber-500 hover:bg-amber-600 text-stone-900 font-black py-5 rounded-2xl shadow-lg transition-all text-xl active:scale-[0.98] border-b-4 border-amber-700">ç¢ºèªè¨˜å¸³</button>
                    </div>

                    <!-- History -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-end px-2">
                            <h2 class="text-stone-500 font-black flex items-center gap-2"><i data-lucide="history" class="w-[18px] h-[18px]"></i> æ­·å²ç´€éŒ„</h2>
                            <button onclick="undoLastRound()" ${state.history.length === 0 ? 'disabled' : ''} class="text-xs font-bold bg-white border border-stone-200 px-3 py-1.5 rounded-lg text-stone-500 flex items-center gap-1 disabled:opacity-30 active:bg-stone-50 shadow-sm transition-all">
                                <i data-lucide="rotate-ccw" class="w-[14px] h-[14px]"></i> åˆªé™¤ä¸Šç­†
                            </button>
                        </div>
                        <div class="space-y-3">
                            ${state.history.length === 0 ? '<div class="bg-stone-100/50 border-2 border-dashed border-stone-200 rounded-3xl p-10 text-center text-stone-300 font-bold">ğŸ§§ ç¥æ‰‹æ°£å¤§ç™¼ï¼</div>' : 
                                state.history.map(round => `
                                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-stone-100 animate-slide-in">
                                        <div class="flex justify-between items-start mb-3 border-b border-stone-50 pb-2">
                                            <div class="flex items-center gap-2">
                                                <span class="bg-stone-800 text-amber-400 text-[10px] font-black px-2 py-0.5 rounded shadow-sm">${round.status}</span>
                                                <span class="font-black text-stone-700 text-sm">${round.winner} (${round.winnerWind}) ${round.type}</span>
                                            </div>
                                            <div class="text-[10px] text-stone-400 font-bold">${round.timestamp}</div>
                                        </div>
                                        <div class="flex justify-between items-center px-1">
                                            <div class="text-xs text-stone-500">
                                                <span class="font-bold text-red-700">${round.points}</span> 
                                                ${round.penalty > 0 ? `<span class="text-rose-400 font-bold">-${round.penalty}</span>` : ''} å°
                                                ${round.combo > 0 ? `<span class="ml-2 text-amber-600 font-bold">(é€£${round.combo})</span>` : ''}
                                            </div>
                                            <div class="grid grid-cols-4 gap-4 flex-1 ml-6">
                                                ${round.changes.map((change, i) => `
                                                    <div class="text-center">
                                                        <div class="text-[9px] text-stone-300 truncate font-bold uppercase tracking-tighter">${state.players[i]}</div>
                                                        <div class="text-[13px] font-black ${change > 0 ? 'text-emerald-600' : change < 0 ? 'text-rose-600' : 'text-stone-200'}">${change > 0 ? '+' + change : change}</div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>

                <!-- Footer Quick Info -->
                <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-xs px-4 pointer-events-none">
                    <div class="bg-stone-800/95 backdrop-blur text-stone-100 p-3 rounded-2xl shadow-2xl flex items-center gap-3 text-xs pointer-events-auto border border-white/10">
                        <i data-lucide="alert-circle" class="w-[16px] h-[16px] text-amber-400 shrink-0"></i>
                        <div class="flex-1 flex justify-between items-center">
                            <span>åº•å°: <span class="text-white font-bold">${state.baseMoney}/${state.pointMoney}</span></span>
                            <span class="bg-white/10 px-2 py-0.5 rounded border border-white/5">
                                èŠå®¶å°: <span class="text-amber-400 font-bold">${1 + state.comboCount * 2}</span>
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- åˆå§‹åŒ– ---
        render();
    </script>
</body>
</html>
